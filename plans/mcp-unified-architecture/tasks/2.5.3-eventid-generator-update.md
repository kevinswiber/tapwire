# Task 2.5.3: EventIdGenerator Update

## Objective
Update EventIdGenerator to include stream ID in generated event IDs, enabling stream identification during reconnection.

## Dependencies
- Task 2.5.1 (Stream Manager Implementation) must be complete

## Implementation Steps

### Step 1: Update Event ID Format
- [ ] Change format to: `{session_id}-{stream_id}-{node_id}-{json_rpc_id}-{counter}`
- [ ] Update documentation
- [ ] Ensure backwards compatibility considerations

### Step 2: Modify EventIdGenerator
- [ ] Add stream_id parameter to generate() method
- [ ] Update internal formatting logic
- [ ] Maintain thread-safe counter

### Step 3: Create Event ID Parser
- [ ] Implement `parse_event_id()` function
- [ ] Extract session_id, stream_id components
- [ ] Handle malformed IDs gracefully
- [ ] Return structured EventIdComponents

### Step 4: Update All Call Sites
- [ ] Find all EventIdGenerator.generate() calls
- [ ] Add stream_id parameter
- [ ] Update tests

## Code Changes

```rust
// src/events/event_id.rs

pub struct EventIdGenerator {
    node_id: String,
    counter: AtomicU64,
}

impl EventIdGenerator {
    /// Generate event ID with stream information
    pub fn generate(
        &self, 
        session_id: &str,
        stream_id: &str,  // NEW
        json_rpc_id: Option<&Value>
    ) -> String {
        let counter = self.counter.fetch_add(1, Ordering::Relaxed);
        let json_id = json_rpc_id
            .and_then(|v| v.as_str())
            .unwrap_or("null");
        
        format!(
            "{}-{}-{}-{}-{}",
            session_id,
            stream_id,  // NEW
            self.node_id,
            json_id,
            counter
        )
    }
}

/// Components parsed from an event ID
pub struct EventIdComponents {
    pub session_id: String,
    pub stream_id: String,
    pub node_id: String,
    pub json_rpc_id: String,
    pub counter: u64,
}

/// Parse event ID into components
pub fn parse_event_id(event_id: &str) -> Option<EventIdComponents> {
    let parts: Vec<&str> = event_id.split('-').collect();
    if parts.len() != 5 {
        return None;
    }
    
    Some(EventIdComponents {
        session_id: parts[0].to_string(),
        stream_id: parts[1].to_string(),
        node_id: parts[2].to_string(),
        json_rpc_id: parts[3].to_string(),
        counter: parts[4].parse().ok()?,
    })
}
```

## Integration Points
- [ ] StreamableIncomingConnection - pass stream_id when generating
- [ ] Event replay logic - use parser to extract stream_id
- [ ] Event tracker - update to handle new format

## Testing Requirements
- [ ] Test new format generation
- [ ] Test parsing valid IDs
- [ ] Test parsing invalid/malformed IDs
- [ ] Test backwards compatibility (old format handling)
- [ ] Test thread safety of counter

## Backwards Compatibility
- Consider supporting old format without stream_id
- Parse both formats in parser
- Log warning for old format

## Success Criteria
- [ ] Event IDs include stream identifier
- [ ] Parser correctly extracts all components
- [ ] Existing tests updated
- [ ] New tests for stream-specific logic
- [ ] No regression in event generation

## Duration
2 hours

## Files to Modify
- `crates/mcp/src/events/event_id.rs` - Main changes
- `crates/mcp/src/transport/http/streamable_incoming.rs` - Update usage
- `crates/mcp/src/transport/http/streaming/event_tracker.rs` - Update tracking
- Test files using EventIdGenerator