# Task 2.5.4: Integration & Testing

## Objective
Integrate all stream tracking components and thoroughly test stream-specific event replay functionality.

## Dependencies
- Task 2.5.2 (EventStore Refactor) must be complete
- Task 2.5.3 (EventIdGenerator Update) must be complete

## Implementation Steps

### Step 1: Wire StreamableIncomingConnection
- [ ] Add stream_id field to connection
- [ ] Register stream on connection creation
- [ ] Unregister stream on disconnect
- [ ] Pass stream_id to all event operations

### Step 2: Implement Reconnection Logic
- [ ] Parse Last-Event-ID header to extract stream_id
- [ ] Look up events only for that stream
- [ ] Handle missing/invalid stream IDs
- [ ] Send replay events before new events

### Step 3: Update Session Cleanup
- [ ] Clean up streams when session ends
- [ ] Clean up events for all streams
- [ ] Update PersistenceWorker for stream cleanup

### Step 4: Integration Tests
- [ ] Test single session, multiple streams
- [ ] Test reconnection with correct stream
- [ ] Test no cross-stream replay
- [ ] Test stream cleanup

### Step 5: End-to-End Testing
- [ ] Manual test with real SSE client
- [ ] Test with curl and Last-Event-ID
- [ ] Verify MCP compliance

## Code Integration Points

```rust
// streamable_incoming.rs updates

impl StreamableIncomingConnection {
    pub async fn new(...) -> Self {
        // Register stream with manager
        let stream_id = stream_manager.register_stream(session_id).await;
        
        Self {
            session_id,
            stream_id,  // NEW field
            // ...
        }
    }
    
    async fn handle_reconnection(&self, last_event_id: Option<String>) {
        if let Some(event_id) = last_event_id {
            // Parse stream ID from event
            if let Some(components) = parse_event_id(&event_id) {
                // Verify stream ID matches
                if components.stream_id == self.stream_id.to_string() {
                    // Get events only from this stream
                    let events = self.event_store.get_events_after(
                        &self.session_id.to_string(),
                        &self.stream_id.to_string(),
                        &event_id
                    ).await;
                    
                    // Replay events
                    for event in events {
                        self.send_sse_event(event).await;
                    }
                }
            }
        }
    }
}
```

## Test Scenarios

### Scenario 1: Multiple Streams, Same Session
```rust
#[tokio::test]
async fn test_multiple_streams_same_session() {
    // Create session
    // Create stream A, send events A1, A2, A3
    // Create stream B, send events B1, B2, B3
    // Disconnect stream A after A2
    // Reconnect with Last-Event-ID: A2
    // Verify only A3 is replayed, not B1-B3
}
```

### Scenario 2: Stream Cleanup
```rust
#[tokio::test]
async fn test_stream_cleanup_on_session_end() {
    // Create session with 2 streams
    // Store events in both
    // End session
    // Verify all streams and events cleaned up
}
```

### Scenario 3: Invalid Stream Reconnection
```rust
#[tokio::test]
async fn test_invalid_stream_reconnection() {
    // Create stream, send events
    // Disconnect
    // Reconnect with wrong stream ID in Last-Event-ID
    // Verify no replay happens
}
```

## Manual Testing Commands

```bash
# Terminal 1: Start server with SSE
cargo run -- forward http --port 8080

# Terminal 2: Connect and capture event IDs
curl -N -H "Accept: text/event-stream" http://localhost:8080/mcp

# Terminal 3: Reconnect with Last-Event-ID
curl -N -H "Accept: text/event-stream" \
     -H "Last-Event-ID: session-stream-node-msg-1" \
     http://localhost:8080/mcp
```

## Success Criteria
- [ ] Streams properly registered/unregistered
- [ ] Events stored with correct stream ID
- [ ] Replay only affects disconnected stream
- [ ] No cross-stream event leakage
- [ ] Clean shutdown removes all stream data
- [ ] All tests pass
- [ ] Manual verification successful

## Duration
3 hours

## Files to Modify
- `crates/mcp/src/transport/http/streamable_incoming.rs` - Main integration
- `crates/mcp/src/session/manager.rs` - Stream cleanup integration
- `crates/mcp/tests/integration/` - New test files
- `crates/mcp/examples/` - Example for testing