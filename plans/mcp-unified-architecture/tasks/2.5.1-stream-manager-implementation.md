# Task 2.5.1: Stream Manager Implementation

## Objective
Implement the core stream tracking infrastructure including StreamId type, StreamManager, and stream lifecycle management.

## Dependencies
- Task 2.5.0 (Stream Tracking Analysis) must be complete

## Implementation Steps

### Step 1: Create StreamId Type
- [ ] Create `src/session/stream.rs` module
- [ ] Implement `StreamId` with UUID backing
- [ ] Add Display, Debug, Clone, Hash, Eq traits
- [ ] Add serialization support

### Step 2: Create StreamMetadata
- [ ] Define metadata structure (creation time, last activity, etc.)
- [ ] Add connection info (remote addr if available)
- [ ] Track event count per stream

### Step 3: Implement StreamManager
- [ ] Create StreamManager struct
- [ ] Implement stream registration
- [ ] Implement stream unregistration  
- [ ] Add stream lookup methods
- [ ] Handle concurrent access with Arc<RwLock>

### Step 4: Stream Lifecycle Methods
- [ ] `register_stream(session_id) -> StreamId`
- [ ] `unregister_stream(session_id, stream_id)`
- [ ] `get_session_streams(session_id) -> Vec<StreamId>`
- [ ] `is_stream_active(stream_id) -> bool`
- [ ] `cleanup_inactive_streams(max_age)`

### Step 5: Integration Points
- [ ] Add StreamManager to SessionManager
- [ ] Update SessionManager constructors
- [ ] Wire stream cleanup with session cleanup

## Code Structure

```rust
// src/session/stream.rs

use uuid::Uuid;
use std::collections::{HashMap, HashSet};
use std::sync::Arc;
use tokio::sync::RwLock;

#[derive(Debug, Clone, Hash, Eq, PartialEq)]
pub struct StreamId(Uuid);

impl StreamId {
    pub fn new() -> Self {
        Self(Uuid::new_v4())
    }
}

pub struct StreamMetadata {
    pub created_at: Instant,
    pub last_activity: Instant,
    pub event_count: u64,
    pub connection_info: Option<String>,
}

pub struct StreamManager {
    /// Active streams per session
    streams: Arc<RwLock<HashMap<SessionId, HashSet<StreamId>>>>,
    /// Stream metadata
    metadata: Arc<RwLock<HashMap<StreamId, StreamMetadata>>>,
}
```

## Testing Requirements
- [ ] Test concurrent stream registration
- [ ] Test stream cleanup
- [ ] Test session-stream association
- [ ] Test metadata tracking
- [ ] Test edge cases (empty sessions, orphaned streams)

## Success Criteria
- [ ] StreamId generates unique IDs
- [ ] StreamManager tracks streams per session
- [ ] Proper cleanup when sessions end
- [ ] Thread-safe concurrent access
- [ ] All tests pass

## Duration
3 hours

## Files to Create/Modify
- Create: `crates/mcp/src/session/stream.rs`
- Modify: `crates/mcp/src/session/mod.rs` (export stream module)
- Modify: `crates/mcp/src/session/manager.rs` (integrate StreamManager)