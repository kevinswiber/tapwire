# Task 2.5.0: Stream Tracking Analysis

## Objective
Analyze the current codebase to understand all touchpoints that need to be updated for proper stream tracking. Identify the scope of changes required to implement stream-specific event replay per MCP specification.

## Background
The MCP spec requires:
- Event IDs must be globally unique across all streams within a session
- Event replay (via Last-Event-ID) must only replay messages from the specific stream that disconnected
- The server must NOT replay messages from different streams

Current implementation incorrectly treats all events as belonging to a session without stream differentiation.

## Key Questions
1. Where are event IDs currently generated and used?
2. How is Last-Event-ID currently handled in reconnection?
3. What components interact with EventStore?
4. How are SSE connections currently tracked?
5. What is the lifecycle of an SSE connection?

## Process

### Step 1: Map Event ID Flow
- [ ] Trace EventIdGenerator usage
- [ ] Find all places event IDs are created
- [ ] Find all places event IDs are parsed/consumed
- [ ] Document the current format and usage

### Step 2: Analyze EventStore Integration
- [ ] List all EventStore method calls
- [ ] Identify all components that store events
- [ ] Identify all components that retrieve events
- [ ] Map the PersistenceWorker integration

### Step 3: SSE Connection Lifecycle
- [ ] How are SSE connections created?
- [ ] How are they tracked currently?
- [ ] When/how are they cleaned up?
- [ ] How is reconnection handled?

### Step 4: Session Management Integration
- [ ] How does SessionManager interact with streams?
- [ ] What session metadata exists?
- [ ] How are sessions cleaned up?

### Step 5: Impact Assessment
- [ ] List all files that need changes
- [ ] Identify breaking changes to APIs
- [ ] Assess testing requirements
- [ ] Consider backwards compatibility

## Deliverables

### 1. Analysis Report (`analysis/stream-tracking-analysis.md`)
- Current architecture diagram
- Component interaction map
- List of all affected files
- Change impact assessment

### 2. Implementation Checklist (`analysis/stream-tracking-checklist.md`)
- Ordered list of changes
- File-by-file modifications needed
- Testing requirements
- Migration considerations

## Commands to Run
```bash
# Find EventIdGenerator usage
rg "EventIdGenerator" crates/mcp/src/

# Find EventStore usage
rg "EventStore|store_event|get_events_after" crates/mcp/src/

# Find Last-Event-ID handling
rg -i "last-event-id" crates/mcp/src/

# Find SSE connection handling
rg "StreamableIncoming|SseEvent" crates/mcp/src/

# Check test coverage
rg "stream|Stream" crates/mcp/src/ --type rust -g "*.rs" | grep -i test
```

## Success Criteria
- [ ] Complete understanding of current event flow
- [ ] Clear list of all components needing updates
- [ ] Identified all breaking changes
- [ ] Created implementation roadmap
- [ ] No surprises during implementation phase

## Duration
2 hours

## Dependencies
- Task 2.4 (SSE Session Tracking) - Complete