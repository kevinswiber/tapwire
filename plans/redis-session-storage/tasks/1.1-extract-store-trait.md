# Task 1.1: Extract SessionStore Trait

## Objective
Refactor the existing `InMemorySessionStore` to implement a common `SessionStore` trait that can be shared by multiple storage backends.

## Current State
- `InMemorySessionStore` is a concrete implementation directly used by `SessionManager`
- No abstraction layer exists for storage operations
- Tight coupling between SessionManager and in-memory storage

## Deliverables

### 1. Create SessionStore Trait
Location: `shadowcat/src/session/store.rs`

```rust
#[async_trait]
pub trait SessionStore: Send + Sync + Debug {
    // Session operations
    async fn create_session(&self, session: Session) -> SessionResult<()>;
    async fn get_session(&self, id: &SessionId) -> SessionResult<Session>;
    async fn update_session(&self, session: Session) -> SessionResult<()>;
    async fn delete_session(&self, id: &SessionId) -> SessionResult<()>;
    async fn list_sessions(&self) -> SessionResult<Vec<Session>>;
    async fn count_sessions(&self) -> SessionResult<usize>;
    
    // Frame operations
    async fn add_frame(&self, envelope: MessageEnvelope) -> SessionResult<()>;
    async fn get_frames(&self, session_id: &SessionId) -> SessionResult<Vec<MessageEnvelope>>;
    async fn delete_frames(&self, session_id: &SessionId) -> SessionResult<()>;
    async fn count_frames(&self, session_id: &SessionId) -> SessionResult<usize>;
    
    // Batch operations (optional, with default implementations)
    async fn get_sessions_batch(&self, ids: &[SessionId]) -> SessionResult<Vec<Session>> {
        // Default: fetch one by one
    }
    
    async fn update_sessions_batch(&self, sessions: Vec<Session>) -> SessionResult<()> {
        // Default: update one by one
    }
}
```

### 2. Implement Trait for InMemorySessionStore
- Update `InMemorySessionStore` to implement `SessionStore`
- Ensure all existing functionality is preserved
- Add `#[async_trait]` to the implementation

### 3. Update SessionManager
- Change `store` field from `Arc<InMemorySessionStore>` to `Arc<dyn SessionStore>`
- Update constructor to accept `Arc<dyn SessionStore>`
- Add builder method: `with_store(store: Arc<dyn SessionStore>)`

### 4. Add Store Factory
Location: `shadowcat/src/session/storage/mod.rs`

```rust
pub enum StorageBackend {
    Memory,
    Redis(RedisConfig),  // For future use
}

pub struct StorageFactory;

impl StorageFactory {
    pub async fn create(backend: StorageBackend) -> Result<Arc<dyn SessionStore>> {
        match backend {
            StorageBackend::Memory => Ok(Arc::new(InMemorySessionStore::new())),
            StorageBackend::Redis(_) => {
                Err(SessionError::NotImplemented("Redis backend not yet implemented"))
            }
        }
    }
}
```

## Implementation Steps

1. **Add async-trait dependency**
   ```toml
   [dependencies]
   async-trait = "0.1"
   ```

2. **Create the trait definition**
   - Define all required methods
   - Add documentation for each method
   - Include error handling via `SessionResult`

3. **Refactor InMemorySessionStore**
   - Implement the new trait
   - Ensure no behavior changes
   - Keep existing optimizations

4. **Update SessionManager**
   - Change type of store field
   - Update all store access points
   - Maintain backward compatibility

5. **Add tests**
   - Test trait implementation
   - Verify SessionManager works with trait object
   - Ensure no performance regression

## Testing Checklist

- [ ] All existing SessionManager tests pass
- [ ] InMemorySessionStore implements all trait methods
- [ ] SessionManager can be created with different store implementations
- [ ] No performance regression (benchmark before/after)
- [ ] Trait object dispatch overhead is acceptable (< 1% impact)

## Success Criteria

- ✅ SessionStore trait is defined and documented
- ✅ InMemorySessionStore implements SessionStore trait
- ✅ SessionManager uses trait object instead of concrete type
- ✅ All existing tests pass without modification
- ✅ No breaking changes to public API
- ✅ Ready for additional storage backends

## Notes

- Keep the trait minimal initially - we can add methods later
- Use `async_trait` for async trait methods
- Consider using `Arc<dyn SessionStore>` vs `Box<dyn SessionStore>`
- Make sure trait is object-safe (no generic methods, no `Self` in return types)
- Document which operations are atomic vs eventual consistency

## Estimated Duration
3 hours

## Dependencies
None - this is the foundational task